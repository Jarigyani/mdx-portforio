---
"filename": "golang-ogp"
"title": "Goã§OGPå–å¾—ã™ã‚‹é–¢æ•°ä½œã£ãŸ"
"date": "2023-03-05"
"description": ""
"eyecatch": "/blog/golang-ogp/eyecatch.webp"
"tags": ["tech", "tutorils"]
---

ã“ã®ãƒ–ãƒ­ã‚°ã«ãƒªãƒ³ã‚¯ã‚’è²¼ã‚‹ã«ã‚ãŸã£ã¦ã€ä»Šã¾ã§ã¯æ–‡å­—åˆ—ã«ãƒªãƒ³ã‚¯ã‚’ä»˜ä¸ã™ã‚‹ã‚ˆã†ãªç°¡ç´ ãªã‚‚ã®ã—ã‹ãªã‹ã£ãŸãŒã€ã‚‚ã£ã¨ãŠã—ã‚ƒã‚Œã«ã—ãŸãã¦ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã‚’è¿½åŠ ã—ãŸ

<OGP url="https://jarigyani.com/blog/golang-ogp" defaultData={
	{
		title: "Goã§OGPå–å¾—ã™ã‚‹é–¢æ•°ä½œã£ãŸ",
		description: "Goã§OGPã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’ä½œã‚Šã€GoogleCloudFunctionsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ",
		image: 'https://jarigyani.com/blog/golang-ogp/eyecatch.webp',
		url: 'https://jarigyani.com/blog/golang-ogp'
	}
} />

ä»Šå›ã¯ä¸ãˆãŸãƒªãƒ³ã‚¯ã‹ã‚‰OGPæƒ…å ±ã‚’ã¨ã£ã¦ãã¦ãã‚Œã‚‹é–¢æ•°ã‚’Goã§ä½œã£ã¦Google Cloud Functionsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã®ã§ã€ãã®æµã‚Œã‚’ãƒ¡ãƒ¢æ›¸ãç¨‹åº¦ã«è¨˜ã—ã¦ãŠã

## ã¨ã‚Šã‚ãˆãšé–¢æ•°ä½œã‚‹

Cloud Functionsã¯ä¹…ã—ã¶ã‚Šã§çŸ¥è­˜ãŒæ›–æ˜§ã ã£ãŸã®ã§å…¬å¼ã®ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å‚ç…§ã—ãªãŒã‚‰é€²ã‚ãŸ

GCPã¯å…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒã‚ã‹ã‚Šã‚„ã™ãã¦ã¨ã¦ã‚‚è‰¯ã„

[ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ](https://cloud.google.com/functions/docs/create-deploy-gcloud?hl=ja)

### åŸºæœ¬çš„ãªæ›¸ãæ–¹

Goã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦Cloud Functionç”¨ã®é–¢æ•°ã‚’æŒ‡å®šã™ã‚‹ã¿ãŸã„

> å…¬å¼ã‹ã‚‰æŒã£ã¦ããŸğŸ‘‡

```go
// Package helloworld provides a set of Cloud Functions samples.
package helloworld

import (
        "fmt"
        "net/http"

        "github.com/GoogleCloudPlatform/functions-framework-go/functions"
)

func init() {
        functions.HTTP("HelloGet", helloGet)
}

// helloGet is an HTTP Cloud Function.
func helloGet(w http.ResponseWriter, r *http.Request) {
        fmt.Fprint(w, "Hello, World!")
}
```

ğŸ‘†ã‚’è‡ªåˆ†ã®ä½œã£ãŸé–¢æ•°ã«ç½®ãæ›ãˆã¦ã„ã

### é–¢æ•°æœ¬ä½“

net/httpã¯ç‰¹ã«æ°—ã«ã™ã‚‹ã“ã¨ãªãä½¿ãˆã‚‹ã‚ˆã†ãªã®ã§ã€ã¨ã‚Šã‚ãˆãšOGPã‚’å–å¾—ã—ãŸã„urlã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å—ã‘å–ã‚‹

> æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªurlã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸã„

> https://go-func.a.run.app?url=[URL]

```go
url := r.URL.Query().Get("url")
if url == "" {
	http.Error(w, "url parameter is required", http.StatusBadRequest)
	return
}
```

ä»¥ä¸‹ã§ã‚µã‚¤ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—

> å–å¾—ã«ã¯goqueryã‚’ä½¿ç”¨ã—ãŸ

```go
doc, err := goquery.NewDocument(url)
if err != nil {
	http.Error(w, "failed to parse html", http.StatusInternalServerError)
	return
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œæˆã—ã¦é€ä¿¡

```go
// OGPæƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®æ§‹é€ ä½“
type Response struct {
	Title       string `json:"title"`
	Description string `json:"description"`
	Image       string `json:"image"`
	Url         string `json:"url"`
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®JSONã‚’ä½œæˆ
respJSON := Response{
	Title:       doc.Find("meta[property='og:title']").AttrOr("content", ""),
	Description: doc.Find("meta[property='og:description']").AttrOr("content", ""),
	Image:       doc.Find("meta[property='og:image']").AttrOr("content", ""),
	Url:         doc.Find("meta[property='og:url']").AttrOr("content", ""),
}

// JSONã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é€ä¿¡
w.Header().Set("Content-Type", "application/json")
json.NewEncoder(w).Encode(respJSON)
```

### ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™

ã“ã®ã¾ã¾ã§ã¯èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ä½¿ç”¨ã§ãã‚‹ã®ã§ã€æ¥ç¶šå…ƒã‚’è‡ªåˆ†ã®ã‚¢ãƒ—ãƒªã«åˆ¶é™ã™ã‚‹

é–¢æ•°ã®æœ€åˆã®ã¨ã“ã‚ã«ä»¥ä¸‹ã‚’è¿½è¨˜

ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¤ã¤ç’°å¢ƒå¤‰æ•°ã«ã—ãŸ(.env.yaml)

[ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨](https://cloud.google.com/functions/docs/configuring/env-var?hl=ja)

> containsè‡ªåˆ†ã§æ›¸ã„ãŸã‘ã©ä»–ã«ã‚ã£ãŸã‹ã‚‚

```go
// è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆ
allowedOrigins := strings.Split(os.Getenv("ALLOWED_ORIGINS"), ",")

// CORSã®è¨­å®š
origin := r.Header.Get("Origin")
if origin == "" || !contains(allowedOrigins, origin) {
	http.Error(w, "forbidden", http.StatusForbidden)
	return
}
w.Header().Set("Access-Control-Allow-Origin", origin)

.
.
.

func contains(list []string, target string) bool {
	for _, v := range list {
		if v == target {
			return true
		}
	}
	return false
}
```

ã‚³ãƒ¼ãƒ‰å…¨ä½“

```go
package ogp

import (
	"encoding/json"
	"net/http"
	"os"
	"strings"

	"github.com/GoogleCloudPlatform/functions-framework-go/functions"
	"github.com/PuerkitoBio/goquery"
)

func init() {
	functions.HTTP("GetOGP", getOGP)
}

func getOGP(w http.ResponseWriter, r *http.Request) {
	// è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã®ãƒªã‚¹ãƒˆ
	allowedOrigins := strings.Split(os.Getenv("ALLOWED_ORIGINS"), ",")

	// CORSã®è¨­å®š
	origin := r.Header.Get("Origin")
	if origin == "" || !contains(allowedOrigins, origin) {
		http.Error(w, "forbidden", http.StatusForbidden)
		return
	}
	w.Header().Set("Access-Control-Allow-Origin", origin)

	url := r.URL.Query().Get("url")
	if url == "" {
		http.Error(w, "url parameter is required", http.StatusBadRequest)
		return
	}

	// æŒ‡å®šã•ã‚ŒãŸURLã®OGPæƒ…å ±ã‚’å–å¾—ã™ã‚‹
	doc, err := goquery.NewDocument(url)
	if err != nil {
		http.Error(w, "failed to parse html", http.StatusInternalServerError)
		return
	}

	// OGPæƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®æ§‹é€ ä½“
	type Response struct {
		Title       string `json:"title"`
		Description string `json:"description"`
		Image       string `json:"image"`
		Url         string `json:"url"`
	}

	// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®JSONã‚’ä½œæˆ
	respJSON := Response{
		Title:       doc.Find("meta[property='og:title']").AttrOr("content", ""),
		Description: doc.Find("meta[property='og:description']").AttrOr("content", ""),
		Image:       doc.Find("meta[property='og:image']").AttrOr("content", ""),
		Url:         doc.Find("meta[property='og:url']").AttrOr("content", ""),
	}

	// JSONã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é€ä¿¡
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(respJSON)
}

func contains(list []string, target string) bool {
	for _, v := range list {
		if v == target {
			return true
		}
	}
	return false
}
```

## ãƒ‡ãƒ—ãƒ­ã‚¤

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

```bash
gcloud functions deploy go-http-function \
--env-vars-file=.env.yaml \
--gen2 \
--runtime=go119 \
--region=[REGION] \
--source=. \
--entry-point=GetOGP \
--trigger-http \
--allow-unauthenticated
```

ãŠã‚ã‚Š